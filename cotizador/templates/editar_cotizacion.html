{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar y Recalcular Cotización{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-lg border-0 rounded-lg">
            <div class="card-header bg-azul-marino text-white text-center">
                <h3 class="fw-bold mb-0">Editar Cotización</h3>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    Estás editando la cotización <strong>#{{ object.pk }}</strong> realizada el {{ object.fecha_creacion|date:"Y-m-d H:i" }}.
                    Recuerda que al modificar el <strong>Origen</strong> o <strong>Destino</strong>, el precio se recalculará automáticamente.
                </p>
                <form method="post">
                    {% csrf_token %}
                    <!-- Campo Origen -->
                    <div class="mb-3">
                        <label for="{{ form.origen.id_for_label }}" class="form-label fw-semibold">Origen</label>
                        {{ form.origen|add_class:"form-control" }}
                        {% if form.origen.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.origen.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Campo Destino -->
                    <div class="mb-3">
                        <label for="{{ form.destino.id_for_label }}" class="form-label fw-semibold">Destino</label>
                        {{ form.destino|add_class:"form-control" }}
                        {% if form.destino.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.destino.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Campo App Seleccionada -->
                    <div class="mb-3">
                        <label for="{{ form.app_seleccionada.id_for_label }}" class="form-label fw-semibold">Aplicación</label>
                        {{ form.app_seleccionada|add_class:"form-control" }}
                        {% if form.app_seleccionada.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.app_seleccionada.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button type="submit" class="btn btn-principal btn-lg">Guardar</button>
                        <a href="{% url 'mis_cotizaciones' %}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if recotizar %}
    <!-- Modal de selección de app -->
    <div class="modal fade" id="seleccionAppModal" tabindex="-1" aria-labelledby="seleccionAppLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-azul-marino text-white">
                    <h5 class="modal-title fw-bold" id="seleccionAppLabel">Selecciona la aplicación de transporte</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        {% for cot in cotizaciones %}
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body text-center">
                                        <img src="{{ cot.app_logo }}" alt="{{ cot.app_nombre }} logo"
                                            class="img-fluid mb-3"
                                            style="height: 60px; width: auto; object-fit: contain;">
                                        <h4 class="card-title text-primary">{{ cot.app_nombre }}</h4>
                                        <hr>
                                        <p class="card-text">
                                            Precio: <br>
                                            <span class="fs-5 fw-bold text-success">${{ cot.precio|floatformat:0 }}</span>
                                        </p>
                                        <p class="card-text">
                                            Tiempo de espera:<br>
                                            <span class="fs-6">{{ cot.tiempo_espera }} min.</span>
                                        </p>
                                    </div>
                                    <div class="card-footer bg-light border-0">
                                        <form method="post" action="{% url 'redireccion' app_id=cot.app_id %}" class="d-grid gap-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="origen" value="{{ cot.origen_nombre }}">
                                            <input type="hidden" name="destino" value="{{ cot.destino_nombre }}">
                                            <input type="hidden" name="precio" value="{{ cot.precio }}">
                                            <input type="hidden" name="tiempo_espera" value="{{ cot.tiempo_espera }}">
                                            <input type="hidden" name="factor_dinamico" value="{{ cot.factor_dinamico }}">
                                            <button type="submit" class="btn btn-lg btn-success">Ir a la app</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if mostrar_modal %}
    <!-- Script para abrir el modal automáticamente -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var modal = new bootstrap.Modal(document.getElementById('seleccionAppModal'));
            modal.show();
        });
    </script>
    {% endif %}
{% endif %}

<!-- Script para forzar recarga al volver atrás -->
<script>
    window.addEventListener("pageshow", function(event) {
        if (event.persisted) {
            window.location.reload();
        }
    });
</script>

{% endblock %}

